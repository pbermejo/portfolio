---
interface Props {
  data: {
    label: string;
    value: number;
  }[];
}

const { data } = Astro.props;

const size = 400;
const center = size / 2;
const maxRadius = 120;
const numPoints = data.length;

function getPoint(index: number, radius: number) {
  const angle = (index * 2 * Math.PI) / numPoints - Math.PI / 2;
  const x = center + radius * Math.cos(angle);
  const y = center + radius * Math.sin(angle);
  return { x, y };
}

// Grid levels (20%, 40%, 60%, 80%, 100%)
const gridLevels = [0.2, 0.4, 0.6, 0.8, 1];
const gridPolygons = gridLevels.map(level => {
  const radius = maxRadius * level;
  return Array.from({ length: numPoints }, (_, i) => {
    const p = getPoint(i, radius);
    return `${p.x},${p.y}`;
  }).join(' ');
});

// Skills polygon
const skillsPoints = data.map((item, i) => {
  const p = getPoint(i, maxRadius * (item.value / 100));
  return `${p.x},${p.y}`;
}).join(' ');

// Label positions (slightly outside the grid)
const labels = data.map((item, i) => {
  const p = getPoint(i, maxRadius + 25);
  let textAnchor = "middle";
  if (p.x > center + 10) textAnchor = "start";
  if (p.x < center - 10) textAnchor = "end";
  
  // Adjust Y for bottom labels
  let dy = "0.35em";
  if (p.y > center + 50) dy = "1em";
  if (p.y < center - 50) dy = "0em";

  return { ...p, label: item.label, textAnchor, dy };
});

const axisLines = data.map((_, i) => {
  const p = getPoint(i, maxRadius);
  return { x2: p.x, y2: p.y };
});
---

<div class="w-full max-w-md mx-auto aspect-square animate-fadeIn">
  <svg viewBox={`0 0 ${size} ${size}`} class="w-full h-full">
    <!-- Grid -->
    {gridPolygons.map(points => (
      <polygon
        points={points}
        class="fill-none stroke-paper-mid dark:stroke-charcoal-mid opacity-20"
      />
    ))}

    <!-- Axes -->
    {axisLines.map(line => (
      <line
        x1={center}
        y1={center}
        x2={line.x2}
        y2={line.y2}
        class="stroke-paper-mid dark:stroke-charcoal-mid opacity-30"
      />
    ))}

    <!-- Chart Area -->
    <polygon
      points={skillsPoints}
      class="fill-paper-tint/20 dark:fill-charcoal-tint/20 stroke-paper-tint dark:stroke-charcoal-tint stroke-[3] transition-all duration-300 ease-out"
    >
        <animate 
            attributeName="points" 
            dur="0.8s" 
            fill="freeze"
            from={`${Array(numPoints).fill(`${center},${center}`).join(' ')}`}
            to={skillsPoints} 
        />
    </polygon>

    <!-- Points -->
    {data.map((item, i) => {
      const p = getPoint(i, maxRadius * (item.value / 100));
      return (
        <circle
          cx={p.x}
          cy={p.y}
          r="4"
          class="fill-paper-tint dark:fill-charcoal-tint"
        />
      );
    })}

    <!-- Labels -->
    {labels.map(l => (
      <text
        x={l.x}
        y={l.y}
        text-anchor={l.textAnchor}
        dy={l.dy}
        class="fill-paper-mid dark:fill-charcoal-mid text-[12px] font-bold uppercase pointer-events-none"
      >
        {l.label}
      </text>
    ))}
  </svg>
</div>
